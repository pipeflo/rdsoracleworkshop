AWSTemplateFormatVersion: "2010-09-09"
Description: This template creates a VPC, Subnets, and an EC2 dev instance

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          Default: Tag Information
        Parameters:
          - TagName
          - TagValue
      - Label:
          Default: NetworkStackName
        Parameters:
          - NetworkStackName
      - Label:
          Default: Key Value Pair
        Parameters:
          - KeyName

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    ConstraintDescription: "must be the name of an existing EC2 KeyPair."

  TagName:
    Type: String
    Description: Tag Id for resources, so as to accumulate all resources generated by this cloud formation
    Default: "WorkshopId"

  TagValue:
    Type: String
    Description: Tag Value for resources, so as to accumulate all resources generated by this cloud formation
    Default: "EMP"

  NetworkStackName:
    Description: >-
      Name of an active CloudFormation stack that contains the networking
      resources, such as the subnet and security group, that will be used in
      this stack.
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: "^[a-zA-Z][-a-zA-Z0-9]*$"

Mappings:
  RegionMap:
    eu-west-2: # London
      AmiId1: ami-0d601d904b1179f00 #EMP-WS2003R2x86-Packager-v1.0.1
      AmiId2: ami-0d2d113537ee5065d #EMP-WS2008R2-Packager-v1.0.1
      AmiId3: ami-0f73293ab806b2f55 #EMP-WS2003R2x86-SQL2000-v1.0.1
      AmiId4: ami-064d290fde473f154 #EMP-WS2019-TargetMachine
      AmiId5: ami-09bd9c600ec854d8d #EMP-WS2019-Troubleshooting-CustQ
      AmiId6: ami-02493a4d9bbf9da81 #EMP-WS2003R2x86-Troubleshooting-CustQ
      AZ1: eu-west-2a
      AZ2: eu-west-2b
      AZ3: eu-west-2c

Resources:
  StandardPackagingInstance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId1
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab1-EMP-WS2003R2x86-Packager-v1.0.1"

  StandardPackagingInstance2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId4
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab1-EMP-WS2019-TargetMachine"

  ReversePackagingInstance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId1
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab2-EMP-WS2003R2x86-Packager-v1.0.1"

  ReversePackagingInstance2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId3
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab2-EMP-WS2003R2x86-SQL2000-v1.0.1"

  ReversePackagingInstance3:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId4
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab2-EMP-WS2019-TargetMachine"

  TSLab1Instance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId5
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab3-EMP-WS2019-Troubleshooting-CustQ"

  TSLab1Instance2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId6
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab3-EMP-WS2003R2x86-Troubleshooting-CustQ"

  TSLab1Instance3:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId1
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab3-EMP-WS2003R2x86-Packager-v1.0.1"

  TSLab2Instance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId2
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab4-EMP-WS2008R2-Packager-v1.0.1(1)"

  TSLab2Instance2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId2
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab4-EMP-WS2008R2-Packager-v1.0.1(2)"

  TSLab2Instance3:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.medium
      ImageId: !FindInMap
        - RegionMap
        - !Ref "AWS::Region"
        - AmiId4
      KeyName: !Ref KeyName
      IamInstanceProfile: !ImportValue
        "Fn::Sub": "${NetworkStackName}-InstanceProfile"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: "true"
          DeleteOnTermination: "true"
          GroupSet:
            - !ImportValue
              "Fn::Sub": "${NetworkStackName}-InstanceSecurityGroup"
          SubnetId: !ImportValue
            "Fn::Sub": "${NetworkStackName}-Subnet1ID"
      Tags:
        - Key: !Ref TagName
          Value: !Ref TagValue
        - Key: "Name"
          Value: "Lab4-EMP-WS2019-TargetMachine"
